<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Departments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    .department-card {
      transition: transform 0.2s;
    }
    .department-card:hover {
      transform: translateY(-5px);
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="row">
      <!-- Department list (left side) -->
      <div class="col-md-8">
        <h2 class="mb-4 text-center">All Departments</h2>
        <ul id="departmentList" class="list-group"></ul>
      </div>

      <!-- Upload form (right side, admin-only) -->
      <div class="col-md-4 mt-4" id="uploadFormContainer" style="display: none;">
        <h4 class="mb-3">Upload Department ZIP</h4>
        <form id="adminUploadForm" class="form" action="/upload" method="post">
          <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="filename" id required>
          </div>
          <div class="mb-3">
            <select class="form-select mb-3" id="department">
  <option value="all" selected>All</option>
  <option value="Agriculture_Department">Agriculture Department</option>
  <option value="Animal Husbandry & Veterinary Department">Animal Husbandry & Veterinary Department</option>
  <option value="Assam Police Department">Assam Police Department</option>
  <option value="Border Protection & Development Department">Border Protection & Development Department</option>
  <option value="Cultural Affairs Department">Cultural Affairs Department</option>
  <option value="Department of Industries & Commerce">Department of Industries & Commerce</option>
  <option value="Department of Information Technology">Department of Information Technology</option>
  <option value="Department of Labour Welfare">Department of Labour Welfare</option>
  <option value="Disaster Management Department">Disaster Management Department</option>
  <option value="Education Department">Education Department</option>
  <option value="Environment & Forest Department">Environment & Forest Department</option>
  <option value="Excise Department">Excise Department</option>
  <option value="Finance Department">Finance Department</option>
  <option value="Fisheries Department">Fisheries Department</option>
  <option value="Food, Civil Supplies & Consumer Affairs Department">Food, Civil Supplies & Consumer Affairs Department</option>
  <option value="General Administration Department">General Administration Department</option>
  <option value="Handloom, Textiles & Sericulture Department">Handloom, Textiles & Sericulture Department</option>
  <option value="Health & Family Welfare Department">Health & Family Welfare Department</option>
  <option value="Higher Education Department">Higher Education Department</option>
  <option value="Home and Political Department">Home and Political Department</option>
  <option value="Housing & Urban Affairs Department">Housing & Urban Affairs Department</option>
  <option value="Irrigation Department">Irrigation Department</option>
  <option value="Judicial Department">Judicial Department</option>
  <option value="Mines & Minerals Department">Mines & Minerals Department</option>
  <option value="Panchayat & Rural Development Department">Panchayat & Rural Development Department</option>
  <option value="Planning & Development Department">Planning & Development Department</option>
  <option value="Power Department">Power Department</option>
  <option value="Public Health Engineering Department">Public Health Engineering Department</option>
  <option value="Public Works Department (PWD)">Public Works Department (PWD)</option>
  <option value="Revenue & Disaster Management Department">Revenue & Disaster Management Department</option>
  <option value="Science & Technology Department">Science & Technology Department</option>
  <option value="Skill, Employment & Entrepreneurship Department">Skill, Employment & Entrepreneurship Department</option>
  <option value="Social Welfare Department">Social Welfare Department</option>
  <option value="Soil Conservation Department">Soil Conservation Department</option>
  <option value="Sports & Youth Welfare Department">Sports & Youth Welfare Department</option>
  <option value="Tourism Department">Tourism Department</option>
  <option value="Transport Department">Transport Department</option>
  <option value="Water Resources Department">Water Resources Department</option>
  <option value="Women and Child Development Department">Women and Child Development Department</option>
  <option value="Welfare of Minorities & Development Department">Welfare of Minorities & Development Department</option>
  <option value="Welfare of Plain Tribes & Backward Classes Department">Welfare of Plain Tribes & Backward Classes Department</option>

</select>
          </div>
          <div class="mb-3">
            <label for="zipFile" class="form-label">ZIP File</label>
            <input type="file" class="form-control" id="zipFile" accept=".zip" required>
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
        <div id="uploadStatus" class="mt-2"></div>
      </div>
    </div>
  </div>

  <script>
    function parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch (e) {
        return null;
      }
    }

    const token = localStorage.getItem('token');
    const user = parseJwt(token);
    const isAdmin = user?.role === 'admin';

    // Show upload form only if admin
    if (isAdmin) {
      document.getElementById('uploadFormContainer').style.display = 'block';
    }

    async function loadDepartments() {
      try {
        const res = await fetch('/api', {
          headers: {
            Authorization: 'Bearer ' + token
          }
        });
        const departments = await res.json();
        const ul = document.getElementById('departmentList');
        departments.forEach(dep => {
          const li = document.createElement('li');
          li.className = 'list-group-item department-card';
          const a = document.createElement('a');
          a.href = `/department.html?name=${encodeURIComponent(dep)}`;
          a.textContent = dep;
          a.className = 'text-primary text-decoration-none';
          li.appendChild(a);
          ul.appendChild(li);
        });
      } catch (err) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.textContent = `Error loading departments: ${err.message}`;
        document.querySelector('.container').appendChild(errorDiv);
      }
    }

    // Upload handler
    if (isAdmin) {
      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('title', document.getElementById('title').value);
        formData.append('file', document.getElementById('zipFile').files[0]);

        try {
          const res = await fetch('/api/upload', {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + token
            },
            body: formData
          });

          const result = await res.json();
          document.getElementById('uploadStatus').innerHTML =
            `<div class="alert alert-success">Upload successful: ${result.message || ''}</div>`;
        } catch (err) {
          document.getElementById('uploadStatus').innerHTML =
            `<div class="alert alert-danger">Upload failed: ${err.message}</div>`;
        }
      });
    }

    loadDepartments();
  </script>
</body>

</html>