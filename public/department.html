<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Department Layers</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    .layer-item {
      transition: transform 0.2s;
    }
    .layer-item:hover {
      transform: translateY(-2px);
    }
    .btn-icon {
      margin-left: 5px;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 id="deptTitle" class="mb-4 text-center">Department</h2>
    <ul id="layerList" class="list-group"></ul>
  </div>

  <!-- Edit Metadata Modal -->
  <div class="modal fade" id="editPopup" tabindex="-1" aria-labelledby="editPopupLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editPopupLabel">Edit Metadata</h5>
          <button type="button" class="btn-close" onclick="closePopup()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="editTitle">
          </div>
          <div class="mb-3">
            <label for="editDesc" class="form-label">Description</label>
            <textarea class="form-control" id="editDesc" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePopup()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveMetadata()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View-Only Metadata Modal -->
  <div class="modal fade" id="infoPopup" tabindex="-1" aria-labelledby="infoPopupLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="infoPopupLabel">Layer Metadata</h5>
          <button type="button" class="btn-close" onclick="closeInfoPopup()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Title:</strong> <span id="infoTitle"></span></p>
          <p><strong>Description:</strong> <span id="infoDesc"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeInfoPopup()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const department = params.get('name');
    document.getElementById('deptTitle').textContent = `Department: ${department}`;

    async function loadLayers() {
      try {
        const res = await fetch(`/api/${department}`, {
          headers: {
            Authorization: 'Bearer ' + localStorage.getItem('token')
          }
        });
        const layers = await res.json();
        const ul = document.getElementById('layerList');
        ul.innerHTML = ''; // Clear existing content
        layers.forEach(layer => {
          const li = document.createElement('li');
          li.className = 'list-group-item layer-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <a href="/api/${department}/${layer.layer_name}" class="text-primary text-decoration-none">${layer.layer_name}</a>
            <div>
              <button class="btn btn-sm btn-outline-info btn-icon" onclick="openInfoPopup('${layer.layer_name}')">🛈</button>
              <button class="btn btn-sm btn-outline-primary btn-icon" onclick="openEditPopup('${layer.layer_name}')">✏️</button>
              <button class="btn btn-sm btn-outline-secondary btn-icon" onclick="openRawGeoJSON('${layer.layer_name}')">🌐</button>
            </div>
          `;
          ul.appendChild(li);
        });
      } catch (err) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.textContent = `Error loading layers: ${err.message}`;
        document.querySelector('.container').appendChild(errorDiv);
      }
    }

    function editLayer(layer) {
      location.href = `/layer.html?department=${department}&layer=${layer}#edit`;
    }

    let selectedLayer = null;

    function openEditPopup(layer) {
      selectedLayer = layer;
      fetch(`/api/${department}/${layer}/metainfo`, {
        headers: {
          Authorization: 'Bearer ' + localStorage.getItem('token')
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('editTitle').value = data.title || '';
        document.getElementById('editDesc').value = data.description || '';
        new bootstrap.Modal(document.getElementById('editPopup')).show();
      })
      .catch(err => {
        alert('Failed to load metadata');
      });
    }

    function saveMetadata() {
      const title = document.getElementById('editTitle').value;
      const description = document.getElementById('editDesc').value;

      fetch(`/api/${department}/${selectedLayer}/metainfo`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({ title, description })
      })
      .then(res => res.json())
      .then(data => {
        alert('Metadata updated');
        closePopup();
        loadLayers(); // refresh list
      })
      .catch(err => {
        alert('Failed to update metadata');
      });
    }

    function closePopup() {
      bootstrap.Modal.getInstance(document.getElementById('editPopup')).hide();
    }

    function openInfoPopup(layer) {
      fetch(`/api/${department}/${layer}/metainfo`, {
        headers: {
          Authorization: 'Bearer ' + localStorage.getItem('token')
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('infoTitle').textContent = data.title || 'N/A';
        document.getElementById('infoDesc').textContent = data.description || 'N/A';
        new bootstrap.Modal(document.getElementById('infoPopup')).show();
      })
      .catch(err => {
        alert('Failed to load metadata');
      });
    }

    function closeInfoPopup() {
      bootstrap.Modal.getInstance(document.getElementById('infoPopup')).hide();
    }

    function openRawGeoJSON(layer) {
      const token = localStorage.getItem('token');
      const url = `/api/${department}/${layer}`;

      const win = window.open();
      fetch(url, {
        headers: {
          Authorization: 'Bearer ' + token
        }
      })
      .then(res => res.json())
      .then(data => {
        win.document.write('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
        win.document.close();
      })
      .catch(() => {
        win.document.write('<p>Failed to load GeoJSON</p>');
        win.document.close();
      });
    }

    loadLayers();
  </script>
</body>
</html>